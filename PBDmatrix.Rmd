Using PBD to perform distance calculations
========================================================

#for this example, fix rank and comm size

```{r,message=FALSE,warning=FALSE}
require(parallel,quietly=TRUE)
require(reshape)

#.rank<-comm.rank()
#.size<-comm.size()
.rank<-1
.size<-2
```

create some 01 data in a matrix

```{r}
comm<-matrix(nrow=10,ncol=10,data=rbinom(100,1,.5))
```

create a list of a pairwise comparisons

```{r fig.width=7, fig.height=6}
z<-combn(nrow(comm),2)
dim(z)
```

On a 10 row table there are 45 unique two way comparisons

Split the number of combinations based on comm.size()
```{r}  
IndexFunction<-splitIndices(ncol(z),.size)
```

Have each rank grab its correct portion of the distance matrix 

```{r}
Index_Space<-z[,IndexFunction[[.rank]]]
```

Loop through the chunk of rank and compute distance matrix
In our real example, we use more complex distance functions, see 
picante::phylosor for example, but we've created out own. 

```{r}
holder<-list()

  #Within a chunk, loop through the indexes and compute betadiversity
  for (x in 1:ncol(Index_Space)){

    #Grab the correct index
    index_col<-Index_Space[,x] 
    
    #get the two way comparison 
    comm.d<-comm[c(index_col[[1]],index_col[[2]]),]

    #compute distance, here we just simple dist, but we will use a user defined function
    comm.dist<-as.matrix(dist(comm.d))
    
    #bind to single row
    out<-melt(comm.dist)
    
    #write to holder
    holder[[x]]<-out
}

#compress list into a dataframe
towrite<-rbind.fill(out)

colnames(towrite)<-c("To","From","value")
#data frame looks like:

head(towrite)
```

Now outsite the rank loop, append to a data file

```{r}

#comm.write.table(towrite,"out.csv")
```

